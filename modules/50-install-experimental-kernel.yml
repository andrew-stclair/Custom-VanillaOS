name: experimental-kernel
type: shell
commands:
  - echo "Installing the latest experimental kernel"
modules:
  - name: experimental kernel pinning
    type: shell
    commands:
      - 'echo "PACKAGE: *" > /etc/apt/preferences.d/linux-kernel'
      - 'echo "Pin: release a=sid" >> /etc/apt/preferences.d/linux-kernel'
      - 'echo "Pin-Priority: 900" >> /etc/apt/preferences.d/linux-kernel'
      - 'echo "" >> /etc/apt/preferences.d/linux-kernel'
      - 'echo "Package: limux-image-amd64 linux-headers-amd64 gcc-*-for-host" >> /etc/apt/preferences.d/linux-kernel'
      - 'echo "Pin: release a=experimental" >> /etc/apt/preferences.d/linux-kernel'
      - 'echo "Pin-Priority: 910" >> /etc/apt/preferences.d/linux-kernel'
      - 'echo "" >> /etc/apt/preferences.d/linux-kernel'
      - 'echo "Types: deb" > /etc/apt/sources.list.d/experimental.sources'
      - 'echo "URIs: http://deb.debian.org/debian/" >> /etc/apt/sources.list.d/experimental.sources'
      - 'echo "Suites: experimental" >> /etc/apt/sources.list.d/experimental.sources'
      - 'echo "Components: main" >> /etc/apt/sources.list.d/experimental.sources'
      - 'echo "Signed-By: /usr/share/keyrings/debian-archive-keyring.gpg" >> /etc/apt/sources.list.d/experimental.sources'
      - 'echo "" >> /etc/apt/sources.list.d/experimental.sources'
      - apt update
  - name: kernel
    type: apt
    source:
      packages:
      - linux-image-amd64/experimental
      - linux-headers-amd64/experimental
  - name: kernel-version-file
    type: shell
    commands:
      - mkdir -p /usr/share/vanilla
      - echo "$(ls -1 /usr/lib/modules | head -n 1)" > /usr/share/vanilla/kernel-version